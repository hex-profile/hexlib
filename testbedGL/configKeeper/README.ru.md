[EN](README.md) RU

[channels]: ../channels/README.ru.md
[cfg-tree]: ../../shellCommon/cfgVars/cfgTree/README.ru.md

ConfigKeeper
============

ConfigKeeper нужен для поддержки асинхронных операций с файлом конфига.

Он владеет хранилищем текстового представления конфигурационных
переменных в памяти, которое отражает текущее представление
переменных всех подсистем. Хранилище является буфером типа [CfgTree][cfg-tree].

При инициализации ConfigKeeper считывает начальный конфигурационный файл
в своё хранилище, а также обновляет реальные переменные всех систем,
используя переданный ему API общей сериализации.
Инициализация происходит до запуска треда, то есть без всякой асинхронности.

После запуска его треда ConfigKeeper работает [так же, как и остальные сервисы][channels].

Его поддерживаемые типы входных обновлений:
* Запрос завершения.
* Обновление конфигурационных переменных: буфер типа [CfgTree][cfg-tree].
* Запрос редактирования конфига.

Получив обновление конфигурационных переменных, ConfigKeeper обновляет
своё хранилище в памяти, а через некоторое время (или при закрытии),
записывает хранилище в конфигурационный файл.
Время задержки определяется параметром "Commit Delay In Seconds".

Получив запрос редактирования конфига, ConfigKeeper сохраняет хранилище в файл
конфига, запускает указанный в запросе текстовый редактор, дожидается
его завершения, а затем обратно считывает файл конфига в своё хранилище.

Затем ConfigKeeper генерирует буфер типа [CfgTree][cfg-tree], содержащий
лишь изменённые человеком конфигурационные переменные. Для этого перед запуском
редактора он очищает флаг "изменён" у всех переменных хранилища, а при чтении
хранилища из файла проверяет совпадение данных и устанавливает этот флаг.

Сгенерировав буфер с обновлением конфигурационных переменных, ConfigKeeper
применяет его к собственным переменным, после чего отправляет его сервису GUI.

Общая схема работы с конфигурационными переменными
==================================================

Все системы пользуются сервисом ConfigKeeper по одинаковому принципу.

В конце очередного цикла, система сериализует себя, проверяя изменения
своих переменных, и, если они есть, генерирует буфер типа [CfgTree][cfg-tree],
содержащий текстовое представление изменённых переменных. После этого она
отправляет буфер сервису ConfigKeeper, который обновляет общее хранилище,
а через некоторое время (или при закрытии) записывает общее хранилище
в конфигурационный файл.

В случае редактирования конфига, ConfigKeeper посылает буфер с обновлением
переменных треду GUI, который применяет его к своим переменным и посылает
другим тредам.
