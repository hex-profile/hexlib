[EN](README.md) RU

CfgTree
=======

Дерево конфига — это структура данных для хранения текстовых значений
конфигурационных переменных в памяти.

Структура узла
--------------

Узел дерева содержит следующие элементы:

* **Имя узла** — хранится в виде строки с хешем. Хеш имени используется для
ускорения поиска узла по имени и является 32-битным беззнаковым целым числом.
* **Данные узла** — хранятся в виде строк, содержащих значение переменной,
комментарий и блочный комментарий.

При поиске узла по имени сначала сравнивается хеш, и если он совпадает,
сравниваются строки.

Выделение памяти для строк
--------------------------

Все строки выделяются жадным методом:

- Если размер строки увеличивается, память выделяется.
- Если размер строки уменьшается, память не освобождается.

Хранение потомков узла
----------------------

Дочерние узлы хранятся в виде связного списка. Для минимизации реаллокаций
поддерживаются два списка:

* **Список дочерних узлов** — содержит активные дочерние узлы дерева.
* **Список теневых узлов** — содержит удаленные узлы, которые не были
освобождены, и могут быть повторно использованы.

При выделении нового дочернего узла сначала проверяется список теневых узлов
на наличие подходящего узла.
Если узел найден, он перемещается в основной список.

Односвязный циклический список
------------------------------

Дочерние узлы хранятся в простом циклическом списке. Каждый узел указывает
на следующий, а последний узел указывает обратно на первый. Если элементов нет,
хранится нулевой указатель. При наличии хотя бы одного элемента список всегда
циклический. Список хранится в виде указателя на его конец, что позволяет
быстро добавлять элементы и легко получать доступ к голове, взяв ссылку
последнего узла на следующий узел.

Операции с деревом
------------------

* Найти дочерний узел по имени.
* Найти или создать дочерний узел по имени — находит существующий узел или
создает новый, если имя не найдено.
* Обработать все дочерние узлы определенным обработчиком.
* Стандартные операции API дельта-буфера.

Поглощение обновления
---------------------

Все узлы поглощаемого дерева перемещаются в основное дерево.
Если соответствующий узел основного дерева уже существует, его данные обновляются
данными узла поглощаемого дерева.
Эта операция не выделяет память и не вызывает исключений.

Генерация обновления для измененных узлов
-----------------------------------------

В данных каждого узла хранится флаг, который говорит о наличии изменений.

Обычная операция установки данных не обновляет этот флаг, поскольку это
требует дополнительных вычислительных затрат.

Однако существует специальная функция установки данных, которая проверяет,
что данные реально изменились и устанавливает этот флаг.

Операция генерации обновления строит новое дерево, содержащее только измененные
узлы данного дерева.
